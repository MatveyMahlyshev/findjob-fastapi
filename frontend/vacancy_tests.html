<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Мои тесты по вакансиям</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
</head>
<body class="bg-gray-100 text-gray-900">
  <header class="bg-white shadow mb-6">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">Мои тесты по вакансиям</h1>
      <a href="profile.html" class="text-blue-600 hover:underline">← Назад в профиль</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8 bg-white shadow rounded-lg space-y-6" id="tests-container">
    <p>Загрузка тестов...</p>
  </main>

  <script>
    async function fetchTests() {
      const token = localStorage.getItem("access_token");
      const container = document.getElementById("tests-container");

      if (!token) {
        container.innerHTML = "<p class='text-red-600'>Необходимо авторизоваться.</p>";
        return;
      }

      try {
        const response = await fetch("http://127.0.0.1:8000/api/v1/profile/candidate/me/tests/", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) throw new Error("Не удалось загрузить тесты");

        const data = await response.json();

        const grouped = {};
        data.forEach(test => {
          const vacancyId = test.response.vacancy.id;
          if (!grouped[vacancyId]) {
            grouped[vacancyId] = {
              vacancy: test.response.vacancy,
              tests: []
            };
          }
          grouped[vacancyId].tests.push(test);
        });

        container.innerHTML = "";

        Object.values(grouped).forEach(group => {
          const { vacancy, tests } = group;

          const section = document.createElement("section");
          section.className = "border p-4 rounded-lg shadow";

          section.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">${vacancy.title} — ${vacancy.company}</h2>
            <p class="mb-4 text-gray-600">${vacancy.description}</p>
            <ul class="space-y-2">
              ${tests.map(t => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                  <span>
                    Навык: <strong>${t.skill.title}</strong> — 
                    ${t.is_completed 
                      ? `<span class='text-green-600'>Завершён</span> — <strong>Результат: ${t.score !== null ? t.score.toFixed(1) + '%' : 'нет данных'}</strong>`
                      : "<span class='text-yellow-600'>Не завершён</span>"
                    }
                  </span>
                  ${t.is_completed 
                    ? '' 
                    : `<a href="test.html?skill_id=${t.skill.id}&response_id=${t.response.id}">
                        <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                          Пройти тест
                        </button>
                      </a>`
                  }
                </li>
              `).join("")}
            </ul>
          `;

          container.appendChild(section);
        });

        if (Object.keys(grouped).length === 0) {
          container.innerHTML = "<p class='text-gray-600'>Нет назначенных тестов.</p>";
        }

      } catch (err) {
        container.innerHTML = `<p class='text-red-600'>Ошибка: ${err.message}</p>`;
      }
    }

    fetchTests();
  </script>
</body>
</html>
