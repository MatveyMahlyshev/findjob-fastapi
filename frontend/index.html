<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ì–ª–∞–≤–Ω–∞—è</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ -->
  <script>
    async function fetchWithRefresh(url, options = {}) {
      let token = localStorage.getItem("access_token");
      if (!options.headers) options.headers = {};
      options.headers["Authorization"] = `Bearer ${token}`;

      let response = await fetch(url, options);

      if (response.status === 401) {
        const refreshToken = localStorage.getItem("refresh_token");
        if (!refreshToken) {
          alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
          window.location.href = "login.html";
          return;
        }

        const refreshResponse = await fetch("http://127.0.0.1:8000/api/v1/auth/refresh/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ refresh_token: refreshToken }),
        });

        if (!refreshResponse.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
          window.location.href = "login.html";
          return;
        }

        const refreshData = await refreshResponse.json();
        localStorage.setItem("access_token", refreshData.access_token);

        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
        options.headers["Authorization"] = `Bearer ${refreshData.access_token}`;
        response = await fetch(url, options);
      }

      return response;
    }

    // –ß—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
    window.fetchWithRefresh = fetchWithRefresh;
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- üîù –®–∞–ø–∫–∞ -->
  <header class="bg-white shadow mb-6">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">–í–∞–∫–∞–Ω—Å–∏–∏ –û–Ω–ª–∞–π–Ω</h1>
      <div id="header-actions" class="space-x-2"></div>
    </div>
  </header>

  <!-- üìÑ –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="max-w-4xl mx-auto px-4">
    <h2 class="text-xl font-semibold mb-4">–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h2>
    <div id="vacancy-list" class="space-y-4"></div>
  </main>

  <script>
    function goToLogin() {
      window.location.href = "login.html";
    }

    function goToRegister() {
      window.location.href = "register.html";
    }

    function goToProfile() {
      window.location.href = "profile.html";
    }

    function logout() {
      localStorage.removeItem("access_token");
      localStorage.removeItem("refresh_token");
      window.location.reload();
    }

    async function isCandidate() {
      const token = localStorage.getItem("access_token");
      try {
        const res = await fetchWithRefresh("http://127.0.0.1:8000/api/v1/profile/candidate/me/");
        return res.ok;
      } catch (_) {
        return false;
      }
    }

    async function renderHeader() {
      const isAuth = !!localStorage.getItem("access_token");
      const actions = document.getElementById("header-actions");

      if (isAuth) {
        if (await isCandidate()) {
          actions.innerHTML = `
            <button onclick="goToProfile()"
              class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
              –ü—Ä–æ—Ñ–∏–ª—å
            </button>
            <button onclick="logout()"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
              –í—ã–π—Ç–∏
            </button>
          `;
        } else {
          actions.innerHTML = `
            <button onclick="logout()"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
              –í—ã–π—Ç–∏
            </button>
          `;
        }
      } else {
        actions.innerHTML = `
          <button onclick="goToLogin()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            –í–æ–π—Ç–∏
          </button>
          <button onclick="goToRegister()"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
          </button>
        `;
      }
    }

    async function loadVacancies() {
      const container = document.getElementById("vacancy-list");
      container.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

      try {
        const response = await fetchWithRefresh("http://127.0.0.1:8000/api/v1/vacancies/");

        if (!response.ok) {
          container.innerHTML = "<p class='text-red-500'>–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>";
          return;
        }

        const data = await response.json();
        if (data.length === 0) {
          container.innerHTML = "<p class='text-gray-500'>–ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π</p>";
          return;
        }

        container.innerHTML = "";
        const isAuthCandidate = await isCandidate();

        data.forEach(vacancy => {
          const skills = vacancy.vacancy_skills.map(v => v.skill.title).join(", ");
          const card = document.createElement("div");
          card.className = "bg-white shadow rounded p-4";

          card.innerHTML = `
            <h3 class="text-lg font-bold">${vacancy.title}</h3>
            <p class="text-gray-500">${vacancy.company}</p>
            <p class="my-2">${vacancy.description}</p>
            <p class="text-sm text-blue-600">–ù–∞–≤—ã–∫–∏: ${skills}</p>
            <div class="mt-3 space-x-2">
              <a href="vacancy.html?vacancy_id=${vacancy.id}" class="text-white bg-blue-600 px-3 py-1 rounded hover:bg-blue-700">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
              ${isAuthCandidate ? `<button onclick="respondToVacancy(${vacancy.id})" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>` : ""}
            </div>
          `;

          container.appendChild(card);
        });
      } catch (err) {
        container.innerHTML = "<p class='text-red-500'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
      }
    }

    async function respondToVacancy(id) {
      try {
        const res = await fetchWithRefresh(`http://127.0.0.1:8000/api/v1/vacancies/vacancy/${id}/respond/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });

        if (res.ok) {
          alert("–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é.");
        } else {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–µ.");
        }
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–∫–ª–∏–∫–µ.");
      }
    }

    window.onload = async () => {
      await renderHeader();
      await loadVacancies();
    };
  </script>
</body>
</html>
